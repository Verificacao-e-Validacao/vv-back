<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Produtos - Sistema de Gestão</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f5f5f5;
            overflow: hidden;
        }
        
        .container_principal{
            width: 800px;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: #0a3d62;
            color: white;
        }

        .header .logo h1 {
            font-size: 1.5rem;
        }

        .main-content {
            padding: 10px;
        }

        .form-group {
            margin-bottom: 0px; 
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block; /* Faz o label ocupar toda a largura */
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%; /* Faz os campos ocuparem toda a largura disponível */
            box-sizing: border-box; /* Inclui padding e border na largura total */
        }

        .footer {
            display: flex;
            justify-content: center;
            padding: 20px;
            background-color: #0a3d62;
            border-radius: 0 0 10px 10px;
        }

        .footer button {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            background-color: #28a745; /* Cor do botão */
            transition: background-color 0.3s; /* Efeito de transição */
        }

        .footer button:hover {
            background-color: #218838; /* Cor do botão ao passar o mouse */
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .header .logo h1 {
                font-size: 1.2rem;
            }

            .footer {
                flex-direction: column;
                gap: 10px;
            }

            .footer button {
                width: 100%;
                padding: 15px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container_principal">
        <div class="container">
            <header class="header">
                <div class="logo">
                    <h1>Cadastro de Produtos</h1>
                </div>
            </header>
            <div id="mensagem" style="display:none; text-align:center; margin:10px 0; padding:10px; border-radius:5px;"></div>

            <div class="main-content">
                <form id="formCadastroProduto" onsubmit="event.preventDefault(); cadastrarProduto();">
                    <div class="form-group">
                        <label for="nome">Nome:</label>
                        <input type="text" id="nome" required>
                    </div>

                    <div class="form-group">
                        <label for="codigo">Código:</label>
                        <input type="text" id="codigo" required>
                    </div>

                    <div class="form-group">
                        <label for="descricao">Descrição:</label>
                        <input type="text" id="descricao" required>
                    </div>

                    <div class="form-group">
                        <label for="valor_venda">Valor de Venda:</label>
                        <input type="number" id="valor_venda" required>
                    </div>

                    <div class="form-group">
                        <label for="detalhes">Detalhes:</label>
                        <input type="text" id="detalhes" required>
                    </div>

                    <div class="form-group">
                        <label for="peso">Peso:</label>
                        <input type="number" id="peso">
                    </div>

                    <div class="form-group">
                        <label for="valor_compra">Valor de Compra:</label>
                        <input type="number" id="valor_compra">
                    </div>

                    <div class="form-group">
                        <label for="quantidade">Quantidade:</label>
                        <input type="number" id="quantidade" required>
                    </div>

                    <div class="form-group">
                        <label for="vencimento">Vencimento:</label>
                        <input type="date" id="vencimento">
                    </div>

                    <div class="footer">
                        <button type="submit">Cadastrar Produto</button>
                    </div>
                </form>
            </div>
        </div>
     </div>
    <script>
        function exibirMensagem(texto, tipo) {
            const mensagemDiv = document.getElementById('mensagem');
            mensagemDiv.style.display = 'block';
            mensagemDiv.textContent = texto;
        
            if (tipo === 'sucesso') {
                mensagemDiv.style.backgroundColor = '#28a745';
                mensagemDiv.style.color = '#ffffff';
            } else if (tipo === 'erro') {
                mensagemDiv.style.backgroundColor = '#dc3545';
                mensagemDiv.style.color = '#ffffff';
            }
        }
        
        async function cadastrarProduto() {
            const baseUrl = window.location.origin;
            const url = `${baseUrl}/api/produtos/`;
        
            try {

                const produto = {
                    nome: document.getElementById('nome').value,
                    codigo: document.getElementById('codigo').value,
                    descricao: document.getElementById('descricao').value,
                    valor_venda: document.getElementById('valor_venda').value,
                    detalhes: document.getElementById('detalhes').value,
                };

                const getProdutoUrl = `${url}?codigo=${produto.codigo}`;
                const getResponse = await fetch(getProdutoUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    }
                });

                if (getResponse.ok) {
                    const produtos = await getResponse.json();
                    if (produtos.length > 0) {
                        const produtoExistente = produtos[0];
                        console.log('Produto já existente:', produtoExistente);

                        cadastrarEstoque(produtoExistente.id);
                        alert('Produto já existe, estoque atualizado.');
                        return;
                    }
                }

                const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                        body: JSON.stringify(produto)
                    });

                if (response.ok) {
                    const data = await response.json();
                    // console.log(data);
                    
                    cadastrarEstoque(data.id)
                } else {
                    const errorData = await response.json();
                    alert(`Erro: ${errorData.detail || 'Falha ao adicionar o produto.'}`);
                }
            
            }  catch (error) {
                console.error('Erro:', error);
                alert('Erro ao adicionar o produto.');
            }
        }
        
        async function cadastrarEstoque(produtoId) {
            const baseUrl = window.location.origin;
            const url = `${baseUrl}/api/estoque/`;
        
            const estoque = {
                peso: document.getElementById('peso').value,
                valor_compra: document.getElementById('valor_compra').value,
                quantidade: document.getElementById('quantidade').value,
                vencimento: document.getElementById('vencimento').value,
                produto: produtoId
            };            

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify(estoque)
                });

                if (response.ok) {
                    const data = await response.json();
                    alert('Produto Adicionado')
                } else {
                    const errorData = await response.json();
                    alert(`Erro: ${errorData.detail || 'Falha ao adicionar o produto.'}`);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao adicionar o Estoque.');
            }
        }   
             
    </script>
</body>
</html>
